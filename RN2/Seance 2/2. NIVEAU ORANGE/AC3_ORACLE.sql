-- *************************
-- PC3 ORACLE
-- *************************

ALTER SESSION SET NLS_DATE_FORMAT = 'DD/MM/YYYY';

-- **** DEFINITON DES STRUCTURES

DROP TABLE PILOTE CASCADE CONSTRAINT PURGE
/
CREATE TABLE PILOTE(
	Idpilote INTEGER,
	Nompilote varchar(30),
	PrenomPilote VARCHAR(30)
	);
/
ALTER TABLE PILOTE
ADD CONSTRAINT PK_PILOTE PRIMARY KEY(IdPilote)
/


DROP TABLE DEPART CASCADE CONSTRAINT PURGE
/
CREATE TABLE DEPART (
	IdDepart INTEGER,
	DateDepart DATE,
	NumeroVol VARCHAR(10)
)
/

ALTER TABLE DEPART 
ADD CONSTRAINT PK_DEPART PRIMARY KEY(IdDepart)
/

DROP TABLE AFFECTATION CASCADE CONSTRAINT PURGE
/
CREATE TABLE AFFECTATION (
	IdDepart INTEGER,
	IdPilote INTEGER
)
/
ALTER TABLE AFFECTATION 
ADD CONSTRAINT PK_AFFECTATION PRIMARY KEY(IdDepart, IdPilote)
/

DROP TABLE HABILITATION CASCADE CONSTRAINT PURGE
/
CREATE TABLE HABILITATION (
	IdDepart INTEGER,
	IdPilote INTEGER
)
/
ALTER TABLE HABILITATION 
ADD CONSTRAINT PK_HABILITATION PRIMARY KEY(IdDepart, IdPilote)
/

ALTER TABLE AFFECTATION
ADD CONSTRAINT FK_AFFECTATION_PILOTE FOREIGN KEY(IdPIlote) REFERENCES PILOTE(IdPilote)
/
ALTER TABLE AFFECTATION
ADD CONSTRAINT FK_AFFECTATION_DEPART FOREIGN KEY(IdDepart) REFERENCES DEPART(IdDepart)
/
ALTER TABLE AFFECTATION
ADD CONSTRAINT CT_HABILITATION_PILOTE FOREIGN KEY(IdDepart, IdPilote) REFERENCES HABILITATION(IdDepart, IdPilote)
/

ALTER TABLE HABILITATION
ADD CONSTRAINT FK_HABILITATION_PILOTE FOREIGN KEY(IdPIlote) REFERENCES PILOTE(IdPilote)
/
ALTER TABLE HABILITATION
ADD CONSTRAINT FK_HABILITATION_DEPART FOREIGN KEY(IdDepart) REFERENCES DEPART(IdDepart)
/

-- *** Données

INSERT INTO PILOTE (IdPilote, NomPilote, PrenomPilote) VALUES (1, 'GARCIN','THOMAS')
/
INSERT INTO PILOTE (IdPilote, NomPilote, PrenomPilote) VALUES (2, 'ARIVELLO','CHRISTINE')
/
INSERT INTO PILOTE (IdPilote, NomPilote, PrenomPilote) VALUES (3, 'PRIMARIS','LEA')
/

INSERT INTO DEPART (IdDepart, DateDepart, NumeroVol) VALUES (1, '13/12/2016','AF333')
/
INSERT INTO DEPART (IdDepart, DateDepart, NumeroVol) VALUES (2, '16/12/2016','AF433')
/
INSERT INTO DEPART (IdDepart, DateDepart, NumeroVol) VALUES (3, '23/12/2016','AF822')
/

INSERT INTO HABILITATION (IdDepart, IdPilote) VALUES (1, 1)
/
INSERT INTO HABILITATION (IdDepart, IdPilote) VALUES (1, 3)
/
INSERT INTO HABILITATION (IdDepart, IdPilote) VALUES (3, 3)
/

INSERT INTO AFFECTATION (IdDepart, IdPilote) VALUES (3, 3)
/


-- ** Requête générant l'anomalie

INSERT INTO AFFECTATION (IdDepart, IdPilote) VALUES (2, 1)
/

SELECT * FROM PILOTE;
SELECT * FROM DEPART;
SELECT * FROM AFFECTATION;
SELECT * FROM HABILITATION ;